{% extends 'base/base.html' %}
{% load static %}

{% block clinicBooking_css %}
<link rel="stylesheet" type="text/css" href="{% static 'clinic/css/clinicBooking.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="container-booking">
    <h1>Book Your Appointment</h1>

    <div class="progress-bar">
        <div class="progress" style="width: 0%"></div>
        <div class="step-indicator active">1</div>
        <div class="step-indicator">2</div>
        <div class="step-indicator">3</div>
    </div>

    <form id="bookingForm" method="POST">
        {% csrf_token %}
        <div class="form-container">
            <!-- Step 1: Personal Information -->
            <div class="form-step active" data-step="1">
                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="first_name">First Name</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="first_name" name="first_name" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="required" for="last_name">Last Name</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="last_name" name="last_name" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="email">Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="email" name="email" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <div class="input-with-icon">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="phone" name="phone">
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button type="button" class="btn-next" onclick="nextStep(1)">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Location & Doctor -->
            <div class="form-step" data-step="2">
                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="country">Country</label>
                        <div class="input-with-icon">
                            <i class="fas fa-globe"></i>
                            <input type="text" id="country" name="country" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="required" for="clinic">Select Clinic</label>
                        <div class="input-with-icon">
                            <i class="fas fa-hospital"></i>
                            <select id="clinic" name="clinic" required onchange="updateDermatologists(this.value)">
                                <option value="">Choose a clinic...</option>
                                {% for clinic in clinics %}
                                    <option value="{{ clinic.id }}" {% if selected_clinic == clinic.id %}selected{% endif %}>
                                        {{ clinic.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="dermatologist">Select Dermatologist</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user-md"></i>
                            <select id="dermatologist" name="dermatologist" required>
                                <option value="">Choose a dermatologist...</option>
                                {% for dermatologist in dermatologists %}
                                    <option value="{{ dermatologist.id }}">{{ dermatologist.first_name }} {{ dermatologist.last_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="required" for="appointment_time">Appointment Date & Time</label>
                        <div class="input-with-icon">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="text" id="appointment_time" name="appointment_time" required>
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button type="button" class="btn-prev" onclick="prevStep(2)">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn-next" onclick="nextStep(2)">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Additional Information -->
            <div class="form-step" data-step="3">
                <div class="form-group">
                    <label class="required" for="subject">Subject</label>
                    <div class="input-with-icon">
                        <i class="fas fa-heading"></i>
                        <input type="text" id="subject" name="subject" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="message">Message</label>
                    <textarea id="message" name="message" placeholder="Please describe your concern..."></textarea>
                </div>

                <div class="buttons">
                    <button type="button" class="btn-prev" onclick="prevStep(3)">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-check"></i> Book Appointment
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
<script>
    let currentStep = 1;
    const totalSteps = 3;

    // Initialize flatpickr for date/time picker
    flatpickr("#appointment_time", {
        enableTime: true,
        minTime: "09:00",
        maxTime: "18:00",
        minDate: "today",
        dateFormat: "Y-m-d H:i",
        disable: [
            function(date) {
                // Disable weekends
                return date.getDay() === 0 || date.getDay() === 6;
            }
        ]
    });

    function updateProgress() {
        const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
        document.querySelector('.progress').style.width = `${progress}%`;

        document.querySelectorAll('.step-indicator').forEach((step, index) => {
            if (index + 1 < currentStep) {
                step.classList.add('complete');
                step.classList.remove('active');
            } else if (index + 1 === currentStep) {
                step.classList.add('active');
                step.classList.remove('complete');
            } else {
                step.classList.remove('active', 'complete');
            }
        });
    }

    function showStep(step) {
        document.querySelectorAll('.form-step').forEach(s => {
            s.classList.remove('active');
        });
        document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
    }

    function nextStep(step) {
        if (step < totalSteps) {
            currentStep = step + 1;
            showStep(currentStep);
            updateProgress();
        }
    }

    function prevStep(step) {
        if (step > 1) {
            currentStep = step - 1;
            showStep(currentStep);
            updateProgress();
        }
    }

    function updateDermatologists(clinicId) {
        if (clinicId) {
            // Reload the page with the selected clinic
            window.location.href = `?clinic=${clinicId}`;
        }
    }

    // Set the selected clinic value after page reload
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const clinicId = urlParams.get('clinic');
        if (clinicId) {
            document.getElementById('clinic').value = clinicId;
        }
    });
</script>
{% endblock content %}